services:
  db:
    image: postgres:16
    container_name: provity-postgres
    environment:
      POSTGRES_DB: provity
      POSTGRES_USER: provity
      POSTGRES_PASSWORD: provity
    ports:
      - "5432:5432"
    volumes:
      - ./pgdata:/var/lib/postgresql/data
      - ./sql/schema.sql:/docker-entrypoint-initdb.d/001_schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U provity -d provity"]
      interval: 5s
      timeout: 5s
      retries: 10

  sandbox-controller:
    build:
      context: ./sandbox_controller
    container_name: provity-sandbox-controller
    environment:
      # Default to 'emulate' for docker-only dynamic verdicts.
      # Use 'mock' for simple wiring tests; use 'winrm' to run on a Windows VM.
      SANDBOX_MODE: ${SANDBOX_MODE:-emulate}
      SANDBOX_MAX_MB: ${SANDBOX_MAX_MB:-10}

      # WinRM target (required when SANDBOX_MODE=winrm)
      WINRM_HOST: ${WINRM_HOST:-}
      WINRM_USER: ${WINRM_USER:-}
      WINRM_PASSWORD: ${WINRM_PASSWORD:-}
      WINRM_TRANSPORT: ${WINRM_TRANSPORT:-ntlm}
    ports:
      - "8000:8000"
